@model ClientesPro.ViewModels.ProductoVM

@{
    ViewData["Title"] =  "Actualizar producto" ;
}

<div class="container mt-4">
    <h2 class="text-center text-primary mb-4">
        <i class="bi bi-box-seam me-2"></i>@ViewData["Title"]
    </h2>

    <div class="card mx-auto" style="max-width:700px;">
        <div class="card-body">
            <form id="formProducto">
                <input type="hidden" id="Id" value="@Model.Id" />

                <div class="mb-3">
                    <label for="Nombre" class="form-label">Nombre</label>
                    <input id="Nombre" name="Nombre" class="form-control" value="@Model?.Nombre" />
                    <div class="invalid-feedback" id="err-Nombre"></div>
                </div>

                <div class="mb-3">
                    <label for="Descripcion" class="form-label">Descripción</label>
                    <textarea id="Descripcion" name="Descripcion" class="form-control">@Model?.Descripcion</textarea>
                    <div class="invalid-feedback" id="err-Descripcion"></div>
                </div>

                <div class="mb-3">
                    <label for="Precio" class="form-label">Precio</label>
                    <input id="Precio" name="Precio" type="number" step="0.01" class="form-control" value="@(Model?.Precio.ToString() ?? "")" />
                    <div class="invalid-feedback" id="err-Precio"></div>
                </div>

                <div class="d-flex gap-2">
                    <button id="btnGuardar" type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Guardar
                    </button>
                    <a class="btn btn-danger px-4" asp-controller="Productos" asp-action="Productos">Volver</a>
                </div>

                <div id="msgGlobal" class="mt-3"></div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            $('#formProducto').on('submit', function (e) {
                e.preventDefault();
                clearErrors();
                $('#btnGuardar').prop('disabled', true);

                var vm = {
                    Id: parseInt($('#Id').val() || 0),
                    Nombre: $('#Nombre').val(),
                    Descripcion: $('#Descripcion').val(),
                    Precio: ($('#Precio').val() === '') ? null : parseFloat($('#Precio').val())
                };

                if (vm.Id && vm.Id > 0) {
                    // Actualizar -> PUT
                    $.ajax({
                        url: '@Url.Action("Actualizar", "Productos")',
                        method: 'PUT',
                        contentType: 'application/json; charset=utf-8',
                        data: JSON.stringify(vm),
                        success: function (res) {
                            // res puede ser true o un objeto
                            if (res === true || (res && res === "true")) {
                                $('#msgGlobal').html('<div class="alert alert-success">Producto actualizado correctamente.</div>');
                                // redirigir a listado después de 1s
                                setTimeout(function () { window.location.href = '@Url.Action("Productos", "Productos")'; }, 900);
                            } else {
                                $('#msgGlobal').html('<div class="alert alert-danger">No se pudo actualizar el producto.</div>');
                            }
                        },
                        error: function (xhr) {
                            handleAjaxError(xhr);
                        },
                        complete: function () { $('#btnGuardar').prop('disabled', false); }
                    });

                } else {
                    // Crear -> POST (CrearAjax)
                    $.ajax({
                        url: '@Url.Action("CrearAjax", "Productos")',
                        method: 'POST',
                        contentType: 'application/json; charset=utf-8',
                        data: JSON.stringify(vm),
                        success: function (resultado) {
                            if (resultado && resultado.exito) {
                                $('#msgGlobal').html('<div class="alert alert-success">Producto creado correctamente.</div>');
                                setTimeout(function () { window.location.href = '@Url.Action("Productos", "Productos")'; }, 900);
                            } else if (resultado && !resultado.exito && resultado.errores) {
                                showModelErrors(resultado.errores);
                                $('#msgGlobal').html('<div class="alert alert-danger">Corrige los errores del formulario.</div>');
                            } else {
                                var msg = (resultado && resultado.mensaje) ? resultado.mensaje : 'Ocurrió un error';
                                $('#msgGlobal').html('<div class="alert alert-danger">' + msg + '</div>');
                            }
                        },
                        error: function (xhr) {
                            handleAjaxError(xhr);
                        },
                        complete: function () { $('#btnGuardar').prop('disabled', false); }
                    });
                }
            });

            function clearErrors() {
                $('#formProducto').find('.is-invalid').removeClass('is-invalid');
                $('#formProducto').find('.invalid-feedback').text('');
                $('#msgGlobal').html('');
            }

            function showModelErrors(errores) {
                // errores: { "Nombre": ["Requerido"], "Precio": ["..."] }
                for (var campo in errores) {
                    if (!errores.hasOwnProperty(campo)) continue;
                    var mensajes = errores[campo];
                    // ModelState keys en MVC suelen venir con prefijo "vm.Nombre" o sólo "Nombre".
                    var key = campo.split('.').pop(); // tomar la última parte por seguridad
                    $('#'+key).addClass('is-invalid');
                    $('#err-' + key).text(mensajes.join(', '));
                }
            }

            function handleAjaxError(xhr) {
                console.error(xhr);
                var texto = 'Error en el servidor.';
                if (xhr.responseJSON && xhr.responseJSON.mensaje) texto = xhr.responseJSON.mensaje;
                $('#msgGlobal').html('<div class="alert alert-danger">' + texto + '</div>');
            }
        });
    </script>
}
