@model IEnumerable<ClientesPro.ViewModels.ProductoVM>

<div class="container mt-4">
    <h2 class="text-center text-primary mb-4">
        <i class="bi bi-box-seam me-2"></i>Listado de Productos
    </h2>

    <!-- Botón de regreso -->
    <div class="text-center mt-4">
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-primary px-4 shadow-sm">
            <i class="bi bi-arrow-left-circle"></i> Regresar al Inicio
        </a>
    </div>


    <!-- Campo de búsqueda -->
    <div class="row mb-3">
        <div class="col-sm-6">
            <label class="form-label small" for="busqueda">Buscar</label>
            <input id="busqueda" type="search" class="form-control" placeholder="Nombre o descripción..." />
        </div>
        <div class="col-sm-3 d-flex align-items-end">
            <button id="btnBuscar" type="button" class="btn btn-outline-primary w-100" onclick="buscar()">Buscar</button>

        </div>

        <div class="col-sm-3 d-flex align-items-end">
            <button class="btn btn-outline-secondary w-100"
                    onclick="location.href='@Url.Action("ActualizarProductos", "Productos", new { id = 0 })'">
                <i class="bi bi-pencil"></i> Agregar producto
            </button>
        </div>

    </div>
    <!-- Tabla de productos -->
    <div class="table-responsive shadow-sm">
        <table id="tablaProductos" class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Id</th>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Precio</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr data-id="@item.Id">
                        <td class="align-middle">@item.Id</td>
                        <td class="align-middle">@item.Nombre</td>
                        <td class="align-middle">@item.Descripcion</td>
                        <td class="align-middle">@item.Precio.ToString("C")</td>
                        <td class="align-middle text-center">
                            <button class="btn btn-sm btn-outline-secondary me-1"
                                    onclick="location.href='@Url.Action("ActualizarProductos", "Productos", new { id = item.Id })'">
                                <i class="bi bi-pencil"></i> Editar
                            </button>



                            @*  <button class="btn btn-sm btn-outline-secondary me-1"
                        onclick="location.href='@Url.Action("ActualizarProductos", "Productos")'">
                        <i class="bi bi-pencil"></i> Editar
                        </button> *@
                            <button class="btn btn-sm btn-outline-danger" onclick="eliminarProducto(@item.Id)">
                                <i class="bi bi-trash"></i> Eliminar
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<script>

    function eliminarProducto(id) {

        $.ajax({
            url: '@Url.Action("Eliminar", "Productos")/' + id, // o usa data: {id: id } si el endpoint no es REST
            method: 'DELETE',
            success: function (resultado) {
                if (resultado === true) {
                    alert('Producto eliminado correctamente.');
                    $('tr[data-id="' + id + '"]').remove(); // elimina la fila directamente de la tabla
                } else {
                    alert('No se pudo eliminar el producto (no encontrado).');
                }
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);
                alert('Ocurrió un error al eliminar el producto.');
            }
        });
    }

    // Función que hace la búsqueda y actualiza la tabla
    function buscar() {
        var busqueda = $("#busqueda").val();

        $.ajax({
            method: 'GET',
            url: '@Url.Action("Buscar", "Productos")',
            data: { criterio: busqueda },
            dataType: 'json',
            success: function (datos) {
                var rows = '';

                if (Array.isArray(datos) && datos.length > 0) {
                    datos.forEach(function (item) {
                        // Aseguramos valores por si vienen null
                        var id = item.id !== undefined ? item.id : '';
                        var nombre = item.nombre || '';
                        var descripcion = item.descripcion || '';
                        var precio = (item.precio !== null && item.precio !== undefined && !isNaN(item.precio))
                            ? parseFloat(item.precio).toFixed(2)
                            : '';

                        rows += '<tr data-id="' + id + '">' +
                            '<td class="align-middle text-center">' + id + '</td>' +
                            '<td class="align-middle">' + nombre + '</td>' +
                            '<td class="align-middle">' + descripcion + '</td>' +
                            '<td class="align-middle text-success fw-bold">$' + precio + '</td>' +
                            '<td class="align-middle text-center">' +
                            '<button class="btn btn-sm btn-outline-secondary me-1"><i class="bi bi-pencil"></i> Editar</button>' +
                            '<button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i> Eliminar</button>' +
                            '</td>' +
                            '</tr>';
                    });
                } else {
                    rows = '<tr><td colspan="5" class="text-center">No se encontraron productos.</td></tr>';
                }

                // Reemplazamos sólo el tbody de la tabla principal
                $('#tablaProductos tbody').html(rows);
                console.log("Resultados actualizados");
            },
            error: function (xhr, status, error) {
                console.error(error);
                $('#tablaProductos tbody').html('<tr><td colspan="5" class="text-center text-danger">Error al realizar la búsqueda.</td></tr>');
            }
        });
    }

</script>
